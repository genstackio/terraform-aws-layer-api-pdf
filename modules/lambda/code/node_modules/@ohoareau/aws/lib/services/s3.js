"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require('path');
const awss3 = new (require('aws-sdk/clients/s3'));
const getFile = async ({ bucket, key, raw = false }) => {
    const f = await awss3.getObject({ Bucket: bucket, Key: key }).promise();
    return { body: (f && f.Body) ? (raw ? f.Body : f.Body.toString()) : undefined };
};
const setFile = async ({ bucket, key }, content) => awss3.putObject({ Bucket: bucket, Key: key, Body: content }).promise();
const deleteFile = async ({ bucket, key }) => awss3.deleteObject({ Bucket: bucket, Key: key }).promise();
const deleteDirectory = async ({ bucket, key }) => {
    const files = await awss3.listObjects({ Bucket: bucket, Prefix: `${key}/` }).promise();
    if (!files || !files.Contents || !files.Contents.length)
        return [];
    const objects = files.Contents.map(f => ({ Key: f.Key }));
    await awss3.deleteObjects({ Bucket: bucket, Delete: { Objects: objects } }).promise();
    return [...objects, ...(await deleteDirectory({ bucket, key }))];
};
const getFileMetadata = async ({ bucket, key, original = false }) => {
    const m = await awss3.headObject({ Bucket: bucket, Key: key }).promise();
    return original ? { ...m } : {
        contentLength: m.ContentLength,
        contentType: m.ContentType,
        eTag: m.ETag,
        lastModified: m.LastModified,
    };
};
const getFileContent = async (query) => (await getFile(query)).body;
const setFileContent = setFile;
const fromJsonFile = async (bucket, key) => JSON.parse(await getFileContent({ bucket, key }));
const toJsonFile = async (bucket, key, data) => setFileContent({ bucket, key }, JSON.stringify(data));
const getFileUploadUrl = async ({ bucket, key, expires = 60 }) => new Promise((resolve, reject) => {
    awss3.createPresignedPost({ Bucket: bucket, Expires: parseInt(expires), Fields: { key } }, (err, data) => {
        if (err) {
            reject(err);
        }
        else {
            resolve({
                uploadUrl: data['url'],
                fileUrl: `${data['url']}/${key}`,
                fields: JSON.stringify(data['fields']),
            });
        }
    });
});
const getFileDownloadUrl = async ({ bucket, key, name, ttl = undefined }) => {
    const fileName = name || path.basename(key);
    const url = await awss3.getSignedUrlPromise('getObject', {
        Bucket: bucket,
        Key: key,
        ResponseContentDisposition: `attachment; filename="${fileName}"`,
        ...(ttl ? { Expires: ttl } : {}),
    });
    return {
        downloadUrl: url,
        fileUrl: url,
        fields: JSON.stringify({}),
        fileName,
    };
};
const getFileViewUrl = async ({ bucket, key, contentType, ttl = undefined }) => {
    const url = await awss3.getSignedUrlPromise('getObject', {
        Bucket: bucket,
        Key: key,
        ...(contentType ? { ResponseContentType: contentType } : {}),
        ResponseContentDisposition: 'inline',
        ...(ttl ? { Expires: ttl } : {}),
    });
    return {
        viewUrl: url,
        fileUrl: url,
        fields: JSON.stringify({}),
        contentType,
    };
};
exports.s3 = {
    deleteFile,
    deleteDirectory,
    getFile,
    getFileContent,
    getFileUploadUrl,
    getFileDownloadUrl,
    getFileViewUrl,
    fromJsonFile,
    toJsonFile,
    setFile,
    setFileContent,
    getFileMetadata,
};
exports.default = exports.s3;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiczMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2VydmljZXMvczMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUM7QUFFbEQsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEdBQUcsS0FBSyxFQUFDLEVBQUUsRUFBRTtJQUNqRCxNQUFNLENBQUMsR0FBRyxNQUFNLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3RFLE9BQU8sRUFBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUMsQ0FBQztBQUNsRixDQUFDLENBQUM7QUFFRixNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FDN0MsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FDdkU7QUFDRCxNQUFNLFVBQVUsR0FBRyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLEVBQUUsRUFBRSxDQUN2QyxLQUFLLENBQUMsWUFBWSxDQUFDLEVBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FDM0Q7QUFFRCxNQUFNLGVBQWUsR0FBRyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLEVBQUUsRUFBRTtJQUM1QyxNQUFNLEtBQUssR0FBRyxNQUFNLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEdBQUcsR0FBRyxFQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNyRixJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTTtRQUFFLE9BQU8sRUFBRSxDQUFDO0lBQ25FLE1BQU0sT0FBTyxHQUFvQixLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBQyxDQUFDLENBQUMsQ0FBQztJQUN6RSxNQUFNLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUMsRUFBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDbEYsT0FBTyxDQUFDLEdBQUcsT0FBTyxFQUFFLEdBQUcsQ0FBQyxNQUFNLGVBQWUsQ0FBQyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuRSxDQUFDLENBQUM7QUFFRixNQUFNLGVBQWUsR0FBRyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsR0FBRyxLQUFLLEVBQW9ELEVBQUUsRUFBRTtJQUNqSCxNQUFNLENBQUMsR0FBRyxNQUFNLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3ZFLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFDLEdBQUcsQ0FBQyxFQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLGFBQWEsRUFBRSxDQUFDLENBQUMsYUFBYTtRQUM5QixXQUFXLEVBQUUsQ0FBQyxDQUFDLFdBQVc7UUFDMUIsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJO1FBQ1osWUFBWSxFQUFFLENBQUMsQ0FBQyxZQUFZO0tBQy9CLENBQUE7QUFDTCxDQUFDLENBQUM7QUFDRixNQUFNLGNBQWMsR0FBRyxLQUFLLEVBQUMsS0FBSyxFQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ2xFLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQztBQUUvQixNQUFNLFlBQVksR0FBRyxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLGNBQWMsQ0FBQyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUM7QUFDNUYsTUFBTSxVQUFVLEdBQUcsS0FBSyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxjQUFjLENBQUMsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBRXBHLE1BQU0sZ0JBQWdCLEdBQUcsS0FBSyxFQUFFLEVBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxPQUFPLEdBQUcsRUFBRSxFQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO0lBQzVGLEtBQUssQ0FBQyxtQkFBbUIsQ0FDckIsRUFBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxRQUFRLENBQU0sT0FBTyxDQUFDLEVBQUUsTUFBTSxFQUFFLEVBQUMsR0FBRyxFQUFDLEVBQUMsRUFDaEUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUU7UUFDVixJQUFJLEdBQUcsRUFBRTtZQUNMLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNmO2FBQU07WUFDSCxPQUFPLENBQUM7Z0JBQ0osU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUM7Z0JBQ3RCLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLEVBQUU7Z0JBQ2hDLE1BQU0sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUN6QyxDQUFDLENBQUM7U0FDTjtJQUNMLENBQUMsQ0FDSixDQUFDO0FBQ04sQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLGtCQUFrQixHQUFHLEtBQUssRUFBRSxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsR0FBRyxTQUFTLEVBQTRELEVBQUUsRUFBRTtJQUNqSSxNQUFNLFFBQVEsR0FBRyxJQUFJLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM1QyxNQUFNLEdBQUcsR0FBRyxNQUFNLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLEVBQUU7UUFDckQsTUFBTSxFQUFFLE1BQU07UUFDZCxHQUFHLEVBQUUsR0FBRztRQUNSLDBCQUEwQixFQUFFLHlCQUF5QixRQUFRLEdBQUc7UUFDaEUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBQyxPQUFPLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztLQUNqQyxDQUFDLENBQUM7SUFDSCxPQUFPO1FBQ0gsV0FBVyxFQUFFLEdBQUc7UUFDaEIsT0FBTyxFQUFFLEdBQUc7UUFDWixNQUFNLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7UUFDMUIsUUFBUTtLQUNYLENBQUE7QUFDTCxDQUFDLENBQUM7QUFFRixNQUFNLGNBQWMsR0FBRyxLQUFLLEVBQUUsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxHQUFHLEdBQUcsU0FBUyxFQUFtRSxFQUFFLEVBQUU7SUFDM0ksTUFBTSxHQUFHLEdBQUcsTUFBTSxLQUFLLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFO1FBQ3JELE1BQU0sRUFBRSxNQUFNO1FBQ2QsR0FBRyxFQUFFLEdBQUc7UUFDUixHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFDLG1CQUFtQixFQUFFLFdBQVcsRUFBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDMUQsMEJBQTBCLEVBQUUsUUFBUTtRQUNwQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFDLE9BQU8sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0tBQ2pDLENBQUMsQ0FBQztJQUNILE9BQU87UUFDSCxPQUFPLEVBQUUsR0FBRztRQUNaLE9BQU8sRUFBRSxHQUFHO1FBQ1osTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1FBQzFCLFdBQVc7S0FDZCxDQUFBO0FBQ0wsQ0FBQyxDQUFDO0FBRVcsUUFBQSxFQUFFLEdBQUc7SUFDZCxVQUFVO0lBQ1YsZUFBZTtJQUNmLE9BQU87SUFDUCxjQUFjO0lBQ2QsZ0JBQWdCO0lBQ2hCLGtCQUFrQjtJQUNsQixjQUFjO0lBQ2QsWUFBWTtJQUNaLFVBQVU7SUFDVixPQUFPO0lBQ1AsY0FBYztJQUNkLGVBQWU7Q0FDbEIsQ0FBQTtBQUVELGtCQUFlLFVBQUUsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBhd3NzMyA9IG5ldyAocmVxdWlyZSgnYXdzLXNkay9jbGllbnRzL3MzJykpO1xuXG5jb25zdCBnZXRGaWxlID0gYXN5bmMgKHtidWNrZXQsIGtleSwgcmF3ID0gZmFsc2V9KSA9PiB7XG4gICAgY29uc3QgZiA9IGF3YWl0IGF3c3MzLmdldE9iamVjdCh7QnVja2V0OiBidWNrZXQsIEtleToga2V5fSkucHJvbWlzZSgpO1xuICAgIHJldHVybiB7Ym9keTogKGYgJiYgZi5Cb2R5KSA/IChyYXcgPyBmLkJvZHkgOiBmLkJvZHkudG9TdHJpbmcoKSkgOiB1bmRlZmluZWR9O1xufTtcblxuY29uc3Qgc2V0RmlsZSA9IGFzeW5jICh7YnVja2V0LCBrZXl9LCBjb250ZW50KSA9PlxuICAgIGF3c3MzLnB1dE9iamVjdCh7QnVja2V0OiBidWNrZXQsIEtleToga2V5LCBCb2R5OiBjb250ZW50fSkucHJvbWlzZSgpXG47XG5jb25zdCBkZWxldGVGaWxlID0gYXN5bmMgKHtidWNrZXQsIGtleX0pID0+XG4gICAgYXdzczMuZGVsZXRlT2JqZWN0KHtCdWNrZXQ6IGJ1Y2tldCwgS2V5OiBrZXl9KS5wcm9taXNlKClcbjtcblxuY29uc3QgZGVsZXRlRGlyZWN0b3J5ID0gYXN5bmMgKHtidWNrZXQsIGtleX0pID0+IHtcbiAgICBjb25zdCBmaWxlcyA9IGF3YWl0IGF3c3MzLmxpc3RPYmplY3RzKHtCdWNrZXQ6IGJ1Y2tldCwgUHJlZml4OiBgJHtrZXl9L2B9KS5wcm9taXNlKCk7XG4gICAgaWYgKCFmaWxlcyB8fCAhZmlsZXMuQ29udGVudHMgfHwgIWZpbGVzLkNvbnRlbnRzLmxlbmd0aCkgcmV0dXJuIFtdO1xuICAgIGNvbnN0IG9iamVjdHM6IHtLZXk6IHN0cmluZ31bXSA9IGZpbGVzLkNvbnRlbnRzLm1hcChmID0+ICh7S2V5OiBmLktleX0pKTtcbiAgICBhd2FpdCBhd3NzMy5kZWxldGVPYmplY3RzKHtCdWNrZXQ6IGJ1Y2tldCwgRGVsZXRlOiB7T2JqZWN0czogb2JqZWN0c319KS5wcm9taXNlKCk7XG4gICAgcmV0dXJuIFsuLi5vYmplY3RzLCAuLi4oYXdhaXQgZGVsZXRlRGlyZWN0b3J5KHtidWNrZXQsIGtleX0pKV07XG59O1xuXG5jb25zdCBnZXRGaWxlTWV0YWRhdGEgPSBhc3luYyAoe2J1Y2tldCwga2V5LCBvcmlnaW5hbCA9IGZhbHNlfToge2J1Y2tldDogc3RyaW5nLCBrZXk6IHN0cmluZywgb3JpZ2luYWw/OiBib29sZWFufSkgPT4ge1xuICAgIGNvbnN0IG0gPSBhd2FpdCBhd3NzMy5oZWFkT2JqZWN0KHtCdWNrZXQ6IGJ1Y2tldCwgS2V5OiBrZXl9KS5wcm9taXNlKCk7XG4gICAgcmV0dXJuIG9yaWdpbmFsID8gey4uLm19IDoge1xuICAgICAgICBjb250ZW50TGVuZ3RoOiBtLkNvbnRlbnRMZW5ndGgsXG4gICAgICAgIGNvbnRlbnRUeXBlOiBtLkNvbnRlbnRUeXBlLFxuICAgICAgICBlVGFnOiBtLkVUYWcsXG4gICAgICAgIGxhc3RNb2RpZmllZDogbS5MYXN0TW9kaWZpZWQsXG4gICAgfVxufTtcbmNvbnN0IGdldEZpbGVDb250ZW50ID0gYXN5bmMgcXVlcnkgPT4gKGF3YWl0IGdldEZpbGUocXVlcnkpKS5ib2R5O1xuY29uc3Qgc2V0RmlsZUNvbnRlbnQgPSBzZXRGaWxlO1xuXG5jb25zdCBmcm9tSnNvbkZpbGUgPSBhc3luYyAoYnVja2V0LCBrZXkpID0+IEpTT04ucGFyc2UoYXdhaXQgZ2V0RmlsZUNvbnRlbnQoe2J1Y2tldCwga2V5fSkpO1xuY29uc3QgdG9Kc29uRmlsZSA9IGFzeW5jIChidWNrZXQsIGtleSwgZGF0YSkgPT4gc2V0RmlsZUNvbnRlbnQoe2J1Y2tldCwga2V5fSwgSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xuXG5jb25zdCBnZXRGaWxlVXBsb2FkVXJsID0gYXN5bmMgKHtidWNrZXQsIGtleSwgZXhwaXJlcyA9IDYwfSkgPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGF3c3MzLmNyZWF0ZVByZXNpZ25lZFBvc3QoXG4gICAgICAgIHtCdWNrZXQ6IGJ1Y2tldCwgRXhwaXJlczogcGFyc2VJbnQoPGFueT5leHBpcmVzKSwgRmllbGRzOiB7a2V5fX0sXG4gICAgICAgIChlcnIsIGRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZFVybDogZGF0YVsndXJsJ10sXG4gICAgICAgICAgICAgICAgICAgIGZpbGVVcmw6IGAke2RhdGFbJ3VybCddfS8ke2tleX1gLFxuICAgICAgICAgICAgICAgICAgICBmaWVsZHM6IEpTT04uc3RyaW5naWZ5KGRhdGFbJ2ZpZWxkcyddKSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICk7XG59KTtcblxuY29uc3QgZ2V0RmlsZURvd25sb2FkVXJsID0gYXN5bmMgKHtidWNrZXQsIGtleSwgbmFtZSwgdHRsID0gdW5kZWZpbmVkfToge2J1Y2tldDogc3RyaW5nLCBrZXk6IHN0cmluZywgbmFtZTogc3RyaW5nLCB0dGw/OiBudW1iZXJ9KSA9PiB7XG4gICAgY29uc3QgZmlsZU5hbWUgPSBuYW1lIHx8IHBhdGguYmFzZW5hbWUoa2V5KTtcbiAgICBjb25zdCB1cmwgPSBhd2FpdCBhd3NzMy5nZXRTaWduZWRVcmxQcm9taXNlKCdnZXRPYmplY3QnLCB7XG4gICAgICAgIEJ1Y2tldDogYnVja2V0LFxuICAgICAgICBLZXk6IGtleSxcbiAgICAgICAgUmVzcG9uc2VDb250ZW50RGlzcG9zaXRpb246IGBhdHRhY2htZW50OyBmaWxlbmFtZT1cIiR7ZmlsZU5hbWV9XCJgLFxuICAgICAgICAuLi4odHRsID8ge0V4cGlyZXM6IHR0bH0gOiB7fSksXG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgZG93bmxvYWRVcmw6IHVybCxcbiAgICAgICAgZmlsZVVybDogdXJsLFxuICAgICAgICBmaWVsZHM6IEpTT04uc3RyaW5naWZ5KHt9KSxcbiAgICAgICAgZmlsZU5hbWUsXG4gICAgfVxufTtcblxuY29uc3QgZ2V0RmlsZVZpZXdVcmwgPSBhc3luYyAoe2J1Y2tldCwga2V5LCBjb250ZW50VHlwZSwgdHRsID0gdW5kZWZpbmVkfToge2J1Y2tldDogc3RyaW5nLCBrZXk6IHN0cmluZywgY29udGVudFR5cGU6IHN0cmluZywgdHRsPzogbnVtYmVyfSkgPT4ge1xuICAgIGNvbnN0IHVybCA9IGF3YWl0IGF3c3MzLmdldFNpZ25lZFVybFByb21pc2UoJ2dldE9iamVjdCcsIHtcbiAgICAgICAgQnVja2V0OiBidWNrZXQsXG4gICAgICAgIEtleToga2V5LFxuICAgICAgICAuLi4oY29udGVudFR5cGUgPyB7UmVzcG9uc2VDb250ZW50VHlwZTogY29udGVudFR5cGV9IDoge30pLFxuICAgICAgICBSZXNwb25zZUNvbnRlbnREaXNwb3NpdGlvbjogJ2lubGluZScsXG4gICAgICAgIC4uLih0dGwgPyB7RXhwaXJlczogdHRsfSA6IHt9KSxcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgICB2aWV3VXJsOiB1cmwsXG4gICAgICAgIGZpbGVVcmw6IHVybCxcbiAgICAgICAgZmllbGRzOiBKU09OLnN0cmluZ2lmeSh7fSksXG4gICAgICAgIGNvbnRlbnRUeXBlLFxuICAgIH1cbn07XG5cbmV4cG9ydCBjb25zdCBzMyA9IHtcbiAgICBkZWxldGVGaWxlLFxuICAgIGRlbGV0ZURpcmVjdG9yeSxcbiAgICBnZXRGaWxlLFxuICAgIGdldEZpbGVDb250ZW50LFxuICAgIGdldEZpbGVVcGxvYWRVcmwsXG4gICAgZ2V0RmlsZURvd25sb2FkVXJsLFxuICAgIGdldEZpbGVWaWV3VXJsLFxuICAgIGZyb21Kc29uRmlsZSxcbiAgICB0b0pzb25GaWxlLFxuICAgIHNldEZpbGUsXG4gICAgc2V0RmlsZUNvbnRlbnQsXG4gICAgZ2V0RmlsZU1ldGFkYXRhLFxufVxuXG5leHBvcnQgZGVmYXVsdCBzMyJdfQ==